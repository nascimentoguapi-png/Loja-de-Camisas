<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brazuka 1.1 | Camisas Tailandesas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #000; font-family: sans-serif; margin: 0; padding: 0; }
        .site-container { background-color: #f3f3f3; max-width: 500px; margin: 0 auto; min-height: 100vh; position: relative; padding-bottom: 20px; }
        .banner-header { width: 100%; height: 130px; overflow: hidden; position: relative; background-color: #000; }
        .banner-img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.2); object-position: center; }
        .carousel { position: relative; width: 100%; height: 350px; overflow: hidden; background-color: #000; }
        .carousel-item { display: none; width: 100%; height: 100%; object-fit: cover; }
        .carousel-item.active { display: block; }
        .card-artilheiro { background-color: #fff; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; align-items: center; padding-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .price-main { color: #333; font-size: 1.2rem; font-weight: 800; }
        .atacado-box { border-top: 1px solid #d4af37; border-bottom: 1px solid #d4af37; width: 90%; margin: 5px 0; text-align: center; padding: 2px 0; }
        .btn-dourado { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); color: #000; border: none; font-weight: 900; transition: 0.3s; }
        .btn-dourado:active { transform: scale(0.95); filter: brightness(1.2); }
        .size-box { border: 1px solid #333; width: 28px; height: 26px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; cursor: pointer; background: white; color: black; }
        .size-selected { background-color: #000 !important; color: #fff !important; }
        .size-off { border: 1px solid #ddd !important; color: #ccc !important; position: relative; cursor: not-allowed !important; pointer-events: none; }
        .size-off::after { content: ""; position: absolute; width: 100%; height: 1px; background: #ccc; transform: rotate(-45deg); }
        .cep-input, .search-input { border: 1px solid #ccc; padding: 8px; border-radius: 4px; width: 100%; font-size: 14px; outline: none; }
        .cep-input:focus, .search-input:focus { border-color: #bf953f; }
    </style>
</head>
<body>

<div class="site-container">
    <header class="banner-header sticky top-0 z-50 border-b border-yellow-600 shadow-xl">
        <img src="banner-topo.png" alt="Brazuka 1.1" class="banner-img">
        <button onclick="toggleCart()" class="absolute right-3 top-3 bg-black/60 p-2 rounded-full border border-white/20">
            <i class="fas fa-shopping-cart text-xl text-white"></i>
            <span id="cart-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] rounded-full px-1.5 py-0.5 font-bold">0</span>
        </button>
    </header>

    <div class="carousel">
        <img src="banner1.jpg" class="carousel-item active" alt="Promo√ß√£o 1">
        <img src="banner2.jpg" class="carousel-item" alt="Promo√ß√£o 2">
        <img src="banner3.jpg" class="carousel-item" alt="Promo√ß√£o 3">
        <button onclick="moveSlide(-1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full text-xs">‚ùÆ</button>
        <button onclick="moveSlide(1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full text-xs">‚ùØ</button>
    </div>

    <div class="p-3 bg-white border-b">
        <div class="relative">
            <input type="text" id="input-busca" onkeyup="filtrarProdutos()" placeholder="Buscar camisa..." class="search-input pl-10">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
        </div>
    </div>

    <h2 class="bg-black text-white text-center py-2 text-sm font-bold uppercase tracking-widest border-t border-yellow-600 shadow-md">Lan√ßamentos</h2>
    
    <div id="grid-produtos" class="p-2 grid grid-cols-2 gap-2 text-black">
        <p class="text-center col-span-2 py-10">Carregando estoque...</p>
    </div>

    <footer class="bg-white border-t mt-6 p-6 text-black text-center">
        <h4 class="font-black uppercase text-sm mb-2">Brazuka 1.1</h4>
        <p class="text-xs text-gray-600 mb-4"><i class="fab fa-whatsapp"></i> 5521986285970</p>
        <p class="text-[10px] text-gray-400">¬© 2026 Todos os direitos reservados.</p>
    </footer>

    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[100] hidden">
        <div class="absolute right-0 top-0 h-full w-[90%] bg-white shadow-xl flex flex-col text-black">
            <div class="p-4 bg-[#333] text-white flex justify-between items-center">
                <h2 class="font-bold uppercase tracking-tighter">üõí Meu Carrinho</h2>
                <button onclick="toggleCart()" class="text-3xl">&times;</button>
            </div>
            
            <div id="cart-items-list" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

            <div class="p-4 bg-gray-100 border-t border-b">
                <label class="text-[10px] font-bold uppercase text-gray-500 mb-1 block">Calcular Frete:</label>
                <div class="flex gap-2">
                    <input type="text" id="cep-destino" placeholder="00000-000" class="cep-input" maxlength="9">
                    <button id="btn-calc-frete" onclick="calcularFreteWorker()" class="bg-black text-white px-4 rounded text-xs font-bold uppercase">Calcular</button>
                </div>
                <div id="resultado-frete" class="mt-2 hidden">
                    <p class="text-[11px] font-bold text-green-700" id="info-frete"></p>
                </div>
            </div>

            <div class="p-4 bg-gray-50">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Subtotal:</span>
                    <span id="subtotal-value">R$ 0,00</span>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Frete:</span>
                    <span id="frete-value">R$ 0,00</span>
                </div>
                <div id="pix-discount-row" class="flex justify-between text-xs text-green-600 font-bold mb-2 hidden">
                    <span>Desconto PIX (10%):</span>
                    <span id="pix-discount-value">- R$ 0,00</span>
                </div>
                <div class="flex justify-between font-black text-lg mb-4 border-t pt-2">
                    <span>TOTAL:</span>
                    <span id="cart-total-value">R$ 0,00</span>
                </div>
                <button id="btn-finalizar" onclick="enviarWhatsApp()" class="w-full bg-[#28a745] text-white py-4 rounded font-black uppercase text-sm shadow-lg disabled:bg-gray-400">Finalizar no WhatsApp</button>
            </div>
        </div>
    </div>
</div>

<script>
    const linkPlanilha = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0m7HN1ePfdwVgr0aaFfYjjFv6r1zag8fZ4x5Ih8XKPLjEIe97nRHqU-hWKWfBEksbOH5Mw8u2Y6VZ/pub?output=csv";
    // Removida a barra final para evitar URLs como //
    const URL_WORKER_FRETE = "https://frete-brazuka.brazukaoficial1-1.workers.dev"; 

    let produtosData = [];
    let carrinho = [];
    let selecoesTemporarias = {};
    let valorFreteGlobal = 0;

    async function carregarProdutos() {
        try {
            const resposta = await fetch(linkPlanilha);
            const dadosText = await resposta.text();
            const linhas = dadosText.split('\n').slice(1);
            const grid = document.getElementById('grid-produtos');
            grid.innerHTML = "";
            produtosData = []; 

            linhas.forEach(linha => {
                const col = linha.split(',');
                if(col.length < 5) return;
                const prod = {
                    id: col[0].trim(),
                    nome: col[1].trim(),
                    preco: parseFloat(col[2]),
                    atacado: parseFloat(col[3]),
                    imagem: col[4].trim(),
                    estoque: { P: parseInt(col[5])||0, M: parseInt(col[6])||0, G: parseInt(col[7])||0, GG: parseInt(col[8])||0 }
                };
                produtosData.push(prod);
                let tamanhosHTML = "";
                for (let tam in prod.estoque) {
                    if (prod.estoque[tam] > 0) tamanhosHTML += `<button onclick="selecionarTamanho(this, '${prod.id}')" class="size-box">${tam}</button>`;
                    else tamanhosHTML += `<button class="size-box size-off">${tam}</button>`;
                }
                grid.innerHTML += `
                    <div class="card-artilheiro item-produto" data-nome="${prod.nome.toLowerCase()}" id="${prod.id}">
                        <img src="${prod.imagem}" class="w-full h-44 object-cover">
                        <h3 class="text-[10px] px-2 h-8 text-center leading-tight font-bold mt-1 uppercase">${prod.nome}</h3>
                        <span class="price-main">R$ ${prod.preco.toFixed(2)}</span>
                        <div class="atacado-box">
                            <span class="text-[9px] text-yellow-700 font-bold uppercase">‚Äî Atacado ‚Äî</span>
                            <p class="text-[8px]">M√≠n. 4 un. por <b>R$ ${prod.atacado.toFixed(2)}</b></p>
                        </div>
                        <div class="flex gap-1 my-2">${tamanhosHTML}</div>
                        <button onclick="adicionarAoCarrinho('${prod.id}')" class="w-[90%] btn-dourado py-2 rounded text-[11px] uppercase shadow-md">Comprar</button>
                    </div>`;
            });
        } catch (e) { console.error(e); }
    }

    function filtrarProdutos() {
        const termo = document.getElementById('input-busca').value.toLowerCase();
        document.querySelectorAll('.item-produto').forEach(prod => {
            prod.style.display = prod.getAttribute('data-nome').includes(termo) ? "flex" : "none";
        });
    }

    async function calcularFreteWorker() {
        const cepDestino = document.getElementById('cep-destino').value.replace(/\D/g, '');
        const btn = document.getElementById('btn-calc-frete');
        const infoFrete = document.getElementById('info-frete');
        const resultadoDiv = document.getElementById('resultado-frete');

        if (cepDestino.length !== 8) { alert("Digite um CEP v√°lido."); return; }
        if (carrinho.length === 0) { alert("Adicione itens ao carrinho primeiro."); return; }
        
        btn.innerText = "Calculando...";
        btn.disabled = true;

        const totalItens = carrinho.reduce((sum, item) => sum + item.qtd, 0);
        const pesoTotal = totalItens * 0.3;

        try {
            const response = await fetch(URL_WORKER_FRETE, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'text/plain' 
                },
                body: JSON.stringify({
                    "from": "25946568",
                    "to": cepDestino,
                    "services": "1,2,3,4,5,6,7,17",
                    "options": { "width": 20, "height": 10, "length": 25, "weight": pesoTotal }
                })
            });

            if (!response.ok) throw new Error("Erro ao conectar com servidor de frete");

            const data = await response.json();
            if (data.error) throw new Error(data.error);

            // Filtra o primeiro servi√ßo v√°lido que n√£o tenha erro e tenha pre√ßo
            const opcao = Array.isArray(data) ? data.find(s => !s.error && s.price) : null;

            if (opcao) {
                valorFreteGlobal = parseFloat(opcao.price);
                resultadoDiv.classList.remove('hidden');
                // Ajustado para pegar o tempo de entrega correto da API
                const prazo = opcao.delivery_range ? opcao.delivery_range.max : opcao.delivery;
                infoFrete.innerText = `üöö ${opcao.name}: R$ ${valorFreteGlobal.toFixed(2)} (${prazo} dias)`;
                renderizarCarrinho();
            } else { 
                alert("CEP n√£o atendido. Tente outro."); 
            }
        } catch (e) { 
            console.error("Erro detalhado:", e);
            alert("O servidor de frete recusou a conex√£o ou o CEP √© inv√°lido."); 
        } finally { 
            btn.innerText = "Calcular"; 
            btn.disabled = false; 
        }
    }

    function renderizarCarrinho() {
        const lista = document.getElementById('cart-items-list');
        let subtotal = 0;
        lista.innerHTML = carrinho.length === 0 ? '<p class="text-center text-gray-400 mt-10">Carrinho vazio</p>' : '';
        
        carrinho.forEach((item, index) => {
            subtotal += item.preco * item.qtd;
            lista.innerHTML += `
                <div class="flex justify-between items-center border-b pb-4">
                    <div class="flex-1">
                        <p class="font-black text-[11px] uppercase">${item.nome}</p>
                        <p class="text-red-600 text-[10px] font-bold">TAM: ${item.tamanho}</p>
                        <p class="text-gray-500 text-[11px]">R$ ${item.preco.toFixed(2)} un.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="alterarQtd(${index}, -1)" class="px-2 bg-gray-200">-</button>
                        <span class="font-bold">${item.qtd}</span>
                        <button onclick="alterarQtd(${index}, 1)" class="px-2 bg-gray-200">+</button>
                    </div>
                </div>`;
        });

        const descontoPix = subtotal * 0.10;
        document.getElementById('subtotal-value').innerText = `R$ ${subtotal.toFixed(2)}`;
        document.getElementById('frete-value').innerText = `R$ ${valorFreteGlobal.toFixed(2)}`;
        
        if (subtotal > 0) {
            document.getElementById('pix-discount-row').classList.remove('hidden');
            document.getElementById('pix-discount-value').innerText = `- R$ ${descontoPix.toFixed(2)}`;
            document.getElementById('cart-total-value').innerText = `R$ ${(subtotal + valorFreteGlobal).toFixed(2)}`;
        } else {
            document.getElementById('pix-discount-row').classList.add('hidden');
            document.getElementById('cart-total-value').innerText = `R$ 0,00`;
        }
    }

    function selecionarTamanho(botao, id) {
        document.getElementById(id).querySelectorAll('.size-box').forEach(b => b.classList.remove('size-selected'));
        botao.classList.add('size-selected');
        selecoesTemporarias[id] = botao.innerText;
    }

    function adicionarAoCarrinho(id) {
        const prod = produtosData.find(p => p.id === id);
        const tam = selecoesTemporarias[id];
        if (!tam) { alert("Selecione o tamanho!"); return; }
        const idx = carrinho.findIndex(i => i.id === id && i.tamanho === tam);
        if (idx !== -1) carrinho[idx].qtd++;
        else carrinho.push({ id, nome: prod.nome, tamanho: tam, preco: prod.preco, qtd: 1 });
        atualizarContador();
        alert("Adicionado!");
    }

    function atualizarContador() { document.getElementById('cart-count').innerText = carrinho.reduce((s, i) => s + i.qtd, 0); }
    function alterarQtd(idx, d) { carrinho[idx].qtd += d; if (carrinho[idx].qtd <= 0) carrinho.splice(idx, 1); atualizarContador(); renderizarCarrinho(); }
    function toggleCart() { document.getElementById('cart-modal').classList.toggle('hidden'); renderizarCarrinho(); }
    function moveSlide(n) { const s = document.querySelectorAll(".carousel-item"); let active = 0; s.forEach((img, i) => { if(img.classList.contains('active')){ active = i; img.classList.remove('active'); }}); let next = (active + n + s.length) % s.length; s[next].classList.add('active'); }
    setInterval(() => moveSlide(1), 5000);

    async function enviarWhatsApp() {
        if (carrinho.length === 0) return;
        let subtotal = carrinho.reduce((s, i) => s + (i.preco * i.qtd), 0);
        let totalFinal = subtotal + valorFreteGlobal;
        let totalPix = (subtotal * 0.9) + valorFreteGlobal;
        
        let msg = "üöÄ *NOVO PEDIDO - BRAZUKA 1.1*\n\n";
        carrinho.forEach((item, i) => msg += `*${i+1}.* ${item.nome} (TAM: ${item.tamanho} | Qtd: ${item.qtd})\n`);
        msg += `\nüí∞ Subtotal: R$ ${subtotal.toFixed(2)}`;
        msg += `\nüöö Frete: R$ ${valorFreteGlobal.toFixed(2)}`;
        msg += `\n‚ö° *Total: R$ ${totalFinal.toFixed(2)}*`;
        msg += `\n\nüî• *PAGANDO NO PIX (10% OFF): R$ ${totalPix.toFixed(2)}*`;
        
        window.open(`https://wa.me/5521986285970?text=${encodeURIComponent(msg)}`, '_blank');
    }

    carregarProdutos();
</script>
</body>
</html>